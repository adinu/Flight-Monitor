<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Destination Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">🛫 Flight Destination Monitor</h1>
            <p class="text-gray-600">Monitor Tustus.co.il for available flight destinations every minute</p>
        </div>

        <!-- Control Panel -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Monitor Control</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Website URL</label>
                    <input
                        type="url"
                        id="urlInput"
                        value="https://www.tustus.co.il/Arkia/Home"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Check Interval</label>
                    <select id="intervalInput" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="1" selected>1 minute</option>
                        <option value="5">5 minutes</option>
                        <option value="10">10 minutes</option>
                        <option value="30">30 minutes</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-4 mb-4">
                <button
                    id="scanBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium"
                >
                    Scan Once
                </button>
                
                <button
                    id="startBtn"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-medium"
                >
                    Start Monitoring
                </button>
                
                <button
                    id="stopBtn"
                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md font-medium"
                >
                    Stop Monitoring
                </button>

                <button
                    id="refreshBtn"
                    class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md font-medium"
                >
                    Refresh
                </button>
            </div>

            <!-- Status Messages -->
            <div id="statusMessage" class="hidden p-3 rounded-md mb-4"></div>
        </div>

        <!-- Monitor Status -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Monitor Status</h2>
            <div id="monitorStatus">
                <p class="text-gray-500 italic">Loading status...</p>
            </div>
        </div>

        <!-- SMS Configuration -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">📱 SMS Alerts</h2>
            <div id="smsStatus">
                <p class="text-gray-500 italic">Loading SMS status...</p>
            </div>
            <div class="mt-4">
                <button
                    id="testSmsBtn"
                    class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md font-medium"
                >
                    Send Test SMS
                </button>
                <button
                    id="smsHistoryBtn"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md font-medium ml-2"
                >
                    View SMS History
                </button>
            </div>
            <div id="smsHistory" class="mt-4 hidden">
                <h3 class="font-medium text-gray-900 mb-2">Recent SMS Alerts</h3>
                <div id="smsHistoryContent">
                    <p class="text-gray-500 italic">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Current Destinations -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">🎯 Current Destinations</h2>
            <div id="currentDestinations">
                <p class="text-gray-500 italic">Loading destinations...</p>
            </div>
        </div>

        <!-- Recent Changes -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">🚨 Recent Changes</h2>
            <div id="recentChanges">
                <p class="text-gray-500 italic">Loading changes...</p>
            </div>
        </div>

        <!-- Scan History -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">📊 Scan History</h2>
            <div id="scanHistory" class="space-y-3 max-h-96 overflow-y-auto">
                <p class="text-gray-500 italic">Loading history...</p>
            </div>
        </div>
    </div>

    <script>
        let refreshInterval;

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = `p-3 rounded-md mb-4 ${
                type === 'error' ? 'bg-red-100 text-red-700 border border-red-300' :
                type === 'success' ? 'bg-green-100 text-green-700 border border-green-300' :
                type === 'warning' ? 'bg-yellow-100 text-yellow-700 border border-yellow-300' :
                'bg-blue-100 text-blue-700 border border-blue-300'
            }`;
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');
            
            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 5000);
        }

        async function scanOnce() {
            const url = document.getElementById('urlInput').value;

            try {
                showStatus('Scanning for destinations...', 'info');
                
                const response = await fetch('/api/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    showStatus(`Scan completed: Found ${result.totalDestinations} destinations, ${result.totalChanges} changes`, 'success');
                    refreshData();
                } else {
                    showStatus(result.error || 'Scan failed', 'error');
                }
            } catch (error) {
                showStatus('Error performing scan: ' + error.message, 'error');
                console.error('Scan error:', error);
            }
        }

        async function startMonitoring() {
            const url = document.getElementById('urlInput').value;
            const intervalMinutes = parseInt(document.getElementById('intervalInput').value);

            try {
                const response = await fetch('/api/monitor/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, intervalMinutes })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    showStatus(`Monitoring started: checking every ${intervalMinutes} minute(s)`, 'success');
                    refreshData();
                } else {
                    showStatus(result.error || 'Failed to start monitoring', 'error');
                }
            } catch (error) {
                showStatus('Error starting monitoring: ' + error.message, 'error');
                console.error('Start monitoring error:', error);
            }
        }

        async function stopMonitoring() {
            const url = document.getElementById('urlInput').value;

            try {
                const response = await fetch('/api/monitor/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();
                showStatus('Monitoring stopped', 'success');
                refreshData();
            } catch (error) {
                showStatus('Error stopping monitoring: ' + error.message, 'error');
                console.error('Stop monitoring error:', error);
            }
        }

        async function refreshMonitorStatus() {
            try {
                const response = await fetch('/api/monitor/status');
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                const statusEl = document.getElementById('monitorStatus');
                
                if (data.activeJobs.length === 0) {
                    statusEl.innerHTML = `
                        <div class="bg-gray-50 border rounded-lg p-4">
                            <div class="text-gray-700">
                                <div class="font-medium">Status: Not monitoring</div>
                                <div class="text-sm text-gray-600 mt-1">Total scans performed: ${data.totalScans}</div>
                            </div>
                        </div>
                    `;
                } else {
                    statusEl.innerHTML = data.activeJobs.map(job => `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="text-green-800">
                                <div class="font-medium">✅ Monitoring Active</div>
                                <div class="text-sm mt-1">URL: ${job.url}</div>
                                <div class="text-sm">Interval: Every ${job.intervalMinutes} minute(s)</div>
                                <div class="text-sm">Started: ${new Date(job.startTime).toLocaleString()}</div>
                                <div class="text-sm">Total scans: ${data.totalScans}</div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error refreshing monitor status:', error);
                document.getElementById('monitorStatus').innerHTML = 
                    `<p class="text-red-500">Error loading status: ${error.message}</p>`;
            }
        }

        async function refreshSMSStatus() {
            try {
                const response = await fetch('/api/sms/status');
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                const smsEl = document.getElementById('smsStatus');
                
                if (data.configured) {
                    smsEl.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="text-green-800">
                                <div class="font-medium">✅ SMS Alerts Enabled</div>
                                <div class="text-sm mt-1">Total SMS sent: ${data.totalSMSSent}</div>
                                <div class="text-sm">Alert phone: ${data.hasAlertNumber ? 'Configured' : 'Not set'}</div>
                            </div>
                        </div>
                    `;
                } else {
                    smsEl.innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="text-yellow-800">
                                <div class="font-medium">⚠️ SMS Alerts Disabled</div>
                                <div class="text-sm mt-1">Missing Twilio configuration</div>
                                <div class="text-sm">Check: Account SID: ${data.hasAccountSid ? '✅' : '❌'}, Auth Token: ${data.hasAuthToken ? '✅' : '❌'}, Phone: ${data.hasFromNumber ? '✅' : '❌'}</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error refreshing SMS status:', error);
                document.getElementById('smsStatus').innerHTML = 
                    `<p class="text-red-500">Error loading SMS status: ${error.message}</p>`;
            }
        }

        async function sendTestSMS() {
            try {
                showStatus('Sending test SMS...', 'info');
                
                const response = await fetch('/api/sms/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const result = await response.json();

                if (result.success) {
                    showStatus('Test SMS sent successfully!', 'success');
                } else {
                    showStatus('SMS test failed: ' + result.error, 'error');
                }
            } catch (error) {
                showStatus('Error sending test SMS: ' + error.message, 'error');
            }
        }

        async function showSMSHistory() {
            const historyEl = document.getElementById('smsHistory');
            const contentEl = document.getElementById('smsHistoryContent');
            
            try {
                const response = await fetch('/api/sms/history');
                const data = await response.json();
                
                if (data.smsHistory.length === 0) {
                    contentEl.innerHTML = '<p class="text-gray-500 italic">No SMS alerts sent yet</p>';
                } else {
                    contentEl.innerHTML = data.smsHistory.map(sms => `
                        <div class="border rounded-lg p-3 bg-purple-50 border-purple-200 mb-2">
                            <div class="flex justify-between items-start mb-1">
                                <div class="font-medium text-purple-900">SMS Alert Sent</div>
                                <div class="text-xs text-purple-600">${new Date(sms.timestamp).toLocaleString()}</div>
                            </div>
                            <div class="text-sm text-purple-700">
                                Changes: ${sms.changes.join(', ')}
                            </div>
                            <div class="text-xs text-purple-600 mt-1">
                                To: ${sms.phone} • SID: ${sms.sid}
                            </div>
                        </div>
                    `).join('');
                }
                
                historyEl.classList.toggle('hidden');
            } catch (error) {
                contentEl.innerHTML = `<p class="text-red-500">Error loading SMS history: ${error.message}</p>`;
                historyEl.classList.remove('hidden');
            }
        }

        async function refreshDestinations() {
            try {
                const response = await fetch('/api/destinations');
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                const destinationsEl = document.getElementById('currentDestinations');
                
                if (data.destinations.length === 0) {
                    destinationsEl.innerHTML = `
                        <p class="text-gray-500 italic">
                            ${data.lastUpdated ? 'No destinations found in last scan' : 'No scan performed yet'}
                        </p>
                        ${data.lastUpdated ? `<p class="text-xs text-gray-400 mt-1">Last updated: ${new Date(data.lastUpdated).toLocaleString()}</p>` : ''}
                    `;
                } else {
                    destinationsEl.innerHTML = `
                        <div class="mb-4">
                            <div class="text-sm text-gray-600 mb-3">
                                Found ${data.totalFound} destinations • Last updated: ${new Date(data.lastUpdated).toLocaleString()}
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                ${data.destinations.map(dest => `
                                    <div class="border rounded-lg p-4 bg-gradient-to-br from-blue-50 to-blue-100">
                                        <div class="flex justify-between items-start mb-2">
                                            <div class="font-medium text-blue-900">${dest.englishName}</div>
                                            <div class="text-sm font-medium text-blue-700">${dest.price}</div>
                                        </div>
                                        <div class="text-xs text-blue-600 space-y-1">
                                            <div>Hebrew: ${dest.hebrewName}</div>
                                            ${dest.departureDate !== 'N/A' ? `<div>Departure: ${dest.departureDate}</div>` : ''}
                                            ${dest.returnDate !== 'N/A' ? `<div>Return: ${dest.returnDate}</div>` : ''}
                                            <div>Found: ${dest.occurrences} times</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error refreshing destinations:', error);
                document.getElementById('currentDestinations').innerHTML = 
                    `<p class="text-red-500">Error loading destinations: ${error.message}</p>`;
            }
        }

        async function refreshChanges() {
            try {
                const response = await fetch('/api/changes?limit=10');
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                const changesEl = document.getElementById('recentChanges');
                
                if (data.changes.length === 0) {
                    changesEl.innerHTML = '<p class="text-gray-500 italic">No changes detected yet</p>';
                } else {
                    changesEl.innerHTML = `
                        <div class="space-y-3">
                            ${data.changes.map(change => `
                                <div class="border-l-4 border-yellow-400 bg-yellow-50 p-4">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="font-medium text-yellow-800">
                                            ${change.totalChanges} change${change.totalChanges !== 1 ? 's' : ''} detected
                                        </div>
                                        <div class="text-xs text-yellow-600">${new Date(change.timestamp).toLocaleString()}</div>
                                    </div>
                                    <div class="text-sm text-yellow-700 space-y-1">
                                        ${change.changes.map(c => `<div>• ${c}</div>`).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error refreshing changes:', error);
                document.getElementById('recentChanges').innerHTML = 
                    `<p class="text-red-500">Error loading changes: ${error.message}</p>`;
            }
        }

        async function refreshHistory() {
            try {
                const response = await fetch('/api/history?limit=20');
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                const historyEl = document.getElementById('scanHistory');
                
                if (data.history.length === 0) {
                    historyEl.innerHTML = '<p class="text-gray-500 italic">No scan history yet</p>';
                } else {
                    historyEl.innerHTML = data.history.map(scan => `
                        <div class="border rounded-lg p-3 ${scan.error ? 'bg-red-50 border-red-200' : scan.totalChanges > 0 ? 'bg-yellow-50 border-yellow-200' : 'bg-gray-50'}">
                            <div class="flex justify-between items-start mb-2">
                                <div class="font-medium text-gray-900">
                                    ${scan.error ? '❌ Scan failed' : `✅ Found ${scan.totalDestinations} destinations`}
                                </div>
                                <div class="text-xs text-gray-500">${new Date(scan.timestamp).toLocaleString()}</div>
                            </div>
                            ${scan.error ? 
                                `<div class="text-sm text-red-600">Error: ${scan.error}</div>` :
                                `<div class="text-sm text-gray-600">
                                    ${scan.destinations.map(d => d.englishName).join(', ') || 'No destinations'}
                                    ${scan.totalChanges > 0 ? `<br><span class="text-yellow-700">Changes: ${scan.changes.join(', ')}</span>` : ''}
                                </div>`
                            }
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error refreshing history:', error);
                document.getElementById('scanHistory').innerHTML = 
                    `<p class="text-red-500">Error loading history: ${error.message}</p>`;
            }
        }

        function refreshData() {
            refreshMonitorStatus();
            refreshDestinations();
            refreshChanges();
            refreshHistory();
            refreshSMSStatus();
        }

        // Test backend connection
        async function testBackend() {
            try {
                const response = await fetch('/api/health');
                if (response.ok) {
                    const data = await response.json();
                    showStatus(`✅ Backend connected: ${data.activeJobs} monitors, ${data.totalScans} scans, ${data.currentDestinations} destinations`, 'success');
                    return true;
                } else {
                    throw new Error(`Backend returned ${response.status}`);
                }
            } catch (error) {
                showStatus(`❌ Backend not available: Make sure to run "node flight-monitor-server.js" on port 3002`, 'error');
                console.error('Backend test failed:', error);
                return false;
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async function() {
            // Test backend connection first
            const backendOk = await testBackend();
            
            if (backendOk) {
                // Load initial data
                refreshData();
                
                // Set up auto-refresh every 30 seconds
                refreshInterval = setInterval(refreshData, 30000);
            }

            // Add event listeners to buttons
            document.getElementById('scanBtn').addEventListener('click', scanOnce);
            document.getElementById('startBtn').addEventListener('click', startMonitoring);
            document.getElementById('stopBtn').addEventListener('click', stopMonitoring);
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
            document.getElementById('testSmsBtn').addEventListener('click', sendTestSMS);
            document.getElementById('smsHistoryBtn').addEventListener('click', showSMSHistory);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>